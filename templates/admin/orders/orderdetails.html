{% extends 'admin/master.html' %}
{% load static %}
{% load tz %}

{% block 'title' %}Order Details{% endblock %}

{% block 'css' %}
<link rel="stylesheet" href="{% static 'assets/node_modules/datatables.net-bs4/css/dataTables.bootstrap4.css' %}">
<link rel="stylesheet" href="{% static 'assets/node_modules/datatables.net-bs4/css/responsive.dataTables.min.css' %}">
<style>
  .shop_table.cart img { max-width: 60px; height: auto; border-radius: 6px; }
  .shop_table.cart thead th { white-space: nowrap; }
  .shop_table.cart tbody td { vertical-align: middle; }
  .order-meta-table td:first-child { color:#6c757d; padding-right:.75rem; white-space:nowrap; }
</style>
{% endblock %}

{% block 'js' %}
<script src="{% static 'assets/node_modules/jquery/dist/jquery.min.js' %}"></script>
<script src="{% static 'assets/node_modules/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/node_modules/datatables.net-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/node_modules/datatables.net-bs4/js/dataTables.responsive.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const table = $('.shop_table.cart').DataTable({
      paging: false,
      info: false,
      searching: false,
      responsive: true,
      order: [] // keep original order
    });
  });
</script>
{% endblock %}

{% block 'main' %}
<div class="page-wrapper">
  <div class="container-fluid">

    <div class="row page-titles">
      <div class="col-md-5 align-self-center">
        <h4 class="text-themecolor">Order Details</h4>
      </div>
    </div>

    {% if messages %}
      <div class="row">
        <div class="col-12">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="row gx-4 gy-3 align-items-stretch">
  <!-- Left: Order details (now same component style as items) -->
  <div class="col-12 col-lg-5 col-xl-4">
    <div class="card">
      <!-- Nav tabs (to mirror the Items card) -->
      <ul class="nav nav-tabs profile-tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#details" role="tab">Details</a>
        </li>
        {# Optional extra tabs for future info #}
        {# <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shipping" role="tab">Shipping</a></li> #}
        {# <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#payment" role="tab">Payment</a></li> #}
      </ul>

      <div class="tab-content">
        <div class="tab-pane active" id="details" role="tabpanel">
          <div class="card-body">
            <table class="table table-hover table-bordered w-100">
              <tbody>
                <tr>
                  <th scope="row" class="w-25 text-muted">Total Payment</th>
                  <td>₹ {{ orderdata.total_payment|floatformat:2  }}</td>
                </tr>
                <tr>
                  <th scope="row" class="text-muted">Discount</th>
                  <td>₹ {{ orderdata.discount|floatformat:2  }}</td>
                </tr>
                <tr>
                  <th scope="row" class="text-muted">Delivery address</th>
                  <td>
                    {{ orderdata.addressline1 }}<br>
                    {% if orderdata.addressline2 %}{{ orderdata.addressline2 }}<br>{% endif %}
                    {{ orderdata.city }}, {{ orderdata.state }} - {{ orderdata.pincode }}
                  </td>
                </tr>
                <tr>
                  <th scope="row" class="text-muted">Order status</th>
                  <td>
                    <span class="badge
                        {% if orderdata.status == 'Pending' %}bg-warning
                        {% elif orderdata.status == 'Confirmed' %}bg-info
                        {% elif orderdata.status == 'Dispatched' %}bg-primary
                        {% elif orderdata.status == 'Shipped' %}bg-primary
                        {% elif orderdata.status == 'Out for delivery' %}bg-primary
                        {% elif orderdata.status == 'Delivered' %}bg-success
                        {% else %}bg-danger{% endif %}">
                        {{ orderdata.status }}
                    </span>

                  </td>
                </tr>
                <tr>
                  <th scope="row" class="text-muted">Placed on</th>
                  <td>{{ orderdata.orderdatetime|date:"M d, Y, g:i A" }}</td>
                </tr>
                <tr>
                  <th scope="row" class="text-muted">Contact</th>
                  <td>{{ orderdata.contactnumber }}</td>
                </tr>

              </tbody>
            </table>

            

          </div>
        </div>

        {# Example extra tab shells if you need them later #}
        {# <div class="tab-pane" id="shipping" role="tabpanel"><div class="card-body">...</div></div> #}
        {# <div class="tab-pane" id="payment" role="tabpanel"><div class="card-body">...</div></div> #}
      </div>
    </div>
    
  </div>

  <!-- Right: Items (unchanged except equal width) -->
  <div class="col-12 col-lg-7 col-xl-8">
    <div class="card">
      <ul class="nav nav-tabs profile-tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#items" role="tab">Items</a>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane active" id="items" role="tabpanel">
          <div class="card-body">
            <div class="profiletimeline">
              <table class="table table-hover table-bordered shop_table cart" style="width:100%">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Product</th>
                    <th scope="col">Name</th>
                    <th scope="col" class="text-end">Price</th>
                    <th scope="col" class="text-end">Qty</th>
                    <th scope="col" class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in itemdata %}
                    <tr>
                      <td><img src="{{ row.product_id.thumbnail_image }}" alt="{{ row.product_id.product_name }}" style="max-width:60px;border-radius:6px"></td>
                      <td><a href="#">{{ row.product_id.product_name }}</a></td>
                      <td class="text-end">₹ {{ row.item_price|floatformat:2  }}</td>
                      <td class="text-end">{{ row.quantity }}</td>
                      <td class="text-end">₹ {{ row.totalofitem|floatformat:2  }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="5" class="text-center text-muted">No items found.</td></tr>
                  {% endfor %}
                </tbody>
              </table>

              <hr>

              <div class="d-flex justify-content-end">
                <div class="text-end">
                  <div>Subtotal: <strong>₹ {{ orderdata.total_payment|add:orderdata.discount|floatformat:2  }}</strong></div>
                  <div>Discount: <strong>₹ {{ orderdata.discount|floatformat:2  }}</strong></div>
                  <div class="fs-5 mt-2">Grand Total: <strong>₹ {{ orderdata.total_payment|floatformat:2  }}</strong></div>
                </div>
              </div>


            </div>
          </div>
        </div><!-- /tab -->
      </div><!-- /tabs -->
      
    </div>
    <div style="margin-bottom: 10px;">
    <div class="fs-5 mt-2" style="margin-bottom: 4px;">Update order status:</div>
    <form method="post" action="/custom/orderdetails/update_status" class="d-flex gap-2">
        {% csrf_token %}
    <input type="hidden" name="order_id" value="{{ orderdata.order_id }}"/>

    <select name="status" class="form-control form-select" required >
        <option value="" disabled {% if not orderdata.status %}selected{% endif %}>Set order status</option>
        <option value="Pending" {% if orderdata.status == 'Pending' %}selected{% endif %}>Pending</option>
        <option value="Confirmed" {% if orderdata.status == 'Confirmed' %}selected{% endif %}>Confirmed</option>
        <option value="Dispatched" {% if orderdata.status == 'Dispatched' %}selected{% endif %}>Dispatched</option>
        <option value="Shipped" {% if orderdata.status == 'Shipped' %}selected{% endif %}>Shipped</option>
        <option value="Out for delivery" {% if orderdata.status == 'Out for delivery' %}selected{% endif %}>Out for delivery</option>
        <option value="Delivered" {% if orderdata.status == 'Delivered' %}selected{% endif %}>Delivered</option>
    </select>
    <button type="submit" class="btn btn-primary" style="margin-bottom: 10px;">Update</button>
    </form>
    </div>
  </div>
</div>

  </div>
</div>
{% endblock %}
